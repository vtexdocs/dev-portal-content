name: Preview Content Changes
on: 
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'
      - 'images/**'
jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Get branch name
        id: get-branch-name
        uses: tj-actions/branch-names@v7
      - name: Get changed markdown files
        id: get-changed-markdown-files
        uses: tj-actions/changed-files@v36
        with:
          files: |
            **.md
            **.mdx
      - name: Fetch navigation.json
        run: curl -o ./navigation.json https://developers.vtex.com/navigation.json
      - name: Map slugs to paths
        id: map-slugs-to-paths
        uses: actions/github-script@v6
        with:
          script: |
            const navigation = require('./navigation.json')

            const paths = {}
            const slugsToPaths = (slugPrefix, obj) => {
              if (!obj || typeof obj !== 'object') return

              if (obj.slug && obj.type === 'markdown') {
                paths[obj.slug] = `${slugPrefix}${obj.slug}`
              }

              for (const key in obj) {
                slugsToPaths(slugPrefix, obj[key])
              }
            }

            navigation.navbar.forEach(({ slugPrefix, categories }) => slugsToPaths(slugPrefix.endsWith('/') ? slugPrefix : `${slugPrefix}/`, categories))
            core.setOutput('slugs-to-paths', JSON.stringify(paths))
      - name: Get preview links
        id: get-preview-links
        uses: actions/github-script@v6
        env:
          BRANCH: ${{ steps.get-branch-name.outputs.head_ref_branch }}
          FILES: ${{ steps.get-changed-markdown-files.outputs.all_changed_files }}
          PATHS: ${{ steps.map-slugs-to-paths.outputs.slugs-to-paths }}
        with:
          script: |
            const branch = process.env.BRANCH
            const paths = JSON.parse(process.env.PATHS)
            const files = process.env.FILES.split(' ')
              .map(file => file.trim())
              .filter(file => file !== '')

            let output = '### üëÅÔ∏è‚Äçüó®Ô∏è Preview changes on Developer Portal\n\n'
            if (files.length === 0) {
              output += `üëâ [Open preview environment](https://developers.vtex.com/api/preview?branch=${branch})\n\n`
              output += '> Note: No Markdown or MDX changes were detected in this pull request.'
            } else {
              output += 'You can use the link below to load the Developer Portal in preview mode with the changes from this branch:\n\n'
              output += `üëâ [Open preview environment](https://developers.vtex.com/api/preview?branch=${branch})\n\n`
              output += 'Below is the list of modified pages and their corresponding preview URLs:\n\n'

              output += `| File | Preview URL | Sidebar |\n`
              output += `|------|-------------|--------|\n`

              for (const file of files) {
                const parts = file.split('/');
                const category = parts[1];
                const slug = file.split('/').pop().split('.')[0];
                console.log(`Processing file: ${file}, category: ${category}, slug: ${slug}, path: ${paths[slug] || 'not found'}`)

                let previewUrl = ''
                let status = ''
                
                if (!paths[slug]) {
                  status = '‚ö†Ô∏è Missing from navigation.json'
                  if (category === "troubleshooting") {
                    previewUrl = `https://developers.vtex.com/docs/troubleshooting/${slug}`;
                  } else if (category === "release-notes") {
                    previewUrl = `https://developers.vtex.com/updates/release-notes/${slug}`;
                  } else if (category === "faststore") {
                    const lastFolder = parts[parts.length - 2];
                    previewUrl = `https://developers.vtex.com/docs/guides/faststore/${lastFolder}-${slug}`;
                  } else {
                    previewUrl = `https://developers.vtex.com/docs/guides/${slug}`;
                  }
                  console.log(previewUrl)
                } else {
                  status = '‚úÖ Listed'
                  previewUrl += `https://developers.vtex.com/${paths[slug]}`;
                }

                output += `| \`${file}\` | ${previewUrl} | ${status} |\n`
              }
            }
            
            core.setOutput('preview-links', output)
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: preview-links
          message: ${{ steps.get-preview-links.outputs.preview-links }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
